if(typeof Alfea=="undefined"||!Alfea){var Alfea={};}Alfea.component=Alfea.component||{};(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML;Alfea.component.ActivityStats=function ActivityStats_constructor(htmlId){Alfea.component.ActivityStats.superclass.constructor.call(this,"Alfea.component.ActivityStats",htmlId,["button","container","datasource","datatable","animation"]);return this;};YAHOO.extend(Alfea.component.ActivityStats,Alfresco.component.Base,{activityStats:null,chart:null,chartBySite:null,options:{types:"all",period:"today",sites:"all",person:"all",chartId:"",chartByDate:{title:"Activity Stats by date",width:600,height:300},chartBySite:{title:"Activity Stats by site",width:450,height:300}},onReady:function ActivityStats_onReady(){var me=this;this.widgets.refreshButton=Alfresco.util.createYUIButton(this,"filters-refresh",this.onRefresh);this.initMultiSelect(this.id+"-filters-form-types");this.initMultiSelect(this.id+"-filters-form-sites");this.formElement=new Alfresco.forms.Form(this.id+"-filters-form");this.loadActivityStats();},onRefresh:function ActivityStats_onRefresh(p_data){this.options.types=this.getTypesValues();this.options.sites=this.getSitesValues();this.options.person=this.getPersonValue();this.options.period=this.getPeriodValue();this.loadActivityStats();},loadActivityStats:function ActivityStats_loadActivityStats(){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("activity-stats.message.refreshing"),spanClass:"wait",displayTime:0});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:Alfresco.constants.PROXY_URI+"alfea/activity-stats/activity-stats",requestContentType:"application/json",responseContentType:"application/json",dataObj:{types:this.options.types,sites:this.options.sites,person:this.options.person,period:this.options.period},successCallback:{fn:this.onSuccess,scope:this},failureCallback:{fn:this.onFailure,scope:this},failureMessage:this.msg("activity-stats.message.failure"),execScripts:true});},onSuccess:function ActivityStats_onSuccess(p_data){this.populateCharts(p_data.json.charts);},onFailure:function ActivityStats_onFailure(p_data){this.widgets.feedbackMessage.destroy();},getPeriodValue:function ActivityStats_getPeriodValue(){return Dom.get(this.id+"-filters-form-period").value;},initMultiSelect:function ActivityStats_initMultiSelect(divId){var labels=document.getElementById(divId).getElementsByTagName("label");for(var i=0,j=labels.length;i<j;i++){labels[i].onclick=function(){if(!this.lastChild.checked){this.lastChild.checked=true;this.className="highlight";}else{this.lastChild.checked=false;this.className="";}};}},getPersonValue:function ActivityStats_getPersonValue(){return Dom.get(this.id+"-filters-form-person").value;},getTypesValues:function ActivityStats_getTypesValues(){return this.getMultipleValues(this.id+"-filters-form-types");},getSitesValues:function ActivityStats_getSitesValues(){return this.getMultipleValues(this.id+"-filters-form-sites");},getMultipleValues:function ActivityStats_getMultipleValues(divId){var div=Dom.get(divId);var inputs=div.getElementsByTagName("input");var values="";for(var i=0;i<inputs.length;i++){if(inputs[i].checked){if(values!=""){values+=",";}values+=inputs[i].value;}}return values;},populateCharts:function ActivityStats_populateCharts(charts){if(charts.length>0){var data=new google.visualization.DataTable();var activitiesSum=0;data.addColumn("string","Time");for(var i=0;i<charts.length;i++){activitiesSum+=parseInt(charts[i].sum);if(charts[i].name=="all"){data.addColumn("number",this.msg("activity-stats.sites.all"));}else{data.addColumn("number",charts[i].displayName);}}data.addRows(charts[0].points.length);for(var i=0;i<charts[0].points.length;i++){data.setValue(i,0,this.convertDateToLabel(charts[0].points[i].start));}for(var i=0;i<charts.length;i++){for(var j=0;j<charts[i].points.length;j++){data.setValue(j,i+1,parseInt(charts[i].points[j].value));}}if(this.chart==null){this.chart=new google.visualization.LineChart(Dom.get(this.id+"-chart-activities-by-date"));}this.chart.draw(data,{width:this.options.chartByDate.width,height:this.options.chartByDate.height,title:this.options.chartByDate.title});var dataBySite=new google.visualization.DataTable();dataBySite.addColumn("string","Sites");dataBySite.addColumn("number","Activities by site");dataBySite.addRows(charts.length);for(var i=0;i<charts.length;i++){if(charts[i].name!="all"){dataBySite.setValue(i,0,charts[i].displayName);dataBySite.setValue(i,1,parseInt(charts[i].sum));}}if(this.chartBySite==null){this.chartBySite=new google.visualization.PieChart(Dom.get(this.id+"-chart-activities-by-site"));}this.chartBySite.draw(dataBySite,{width:this.options.chartBySite.width,height:this.options.chartBySite.height,title:this.options.chartBySite.title});if(activitiesSum==0){this.widgets.feedbackMessage.destroy();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("activity-stats.message.no-activity"),spanClass:"alert",displayTime:3});return;}this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("activity-stats.message.success"),spanClass:"alert",displayTime:3});return;}this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("activity-stats.message.failed"),spanClass:"alert",displayTime:3});},convertDateToLabel:function ActivityStats_convertDateToLabel(dateStr){switch(this.options.period){case"today":return dateStr.substring(11,16);case"week":case"month":return dateStr.substring(5,10);case"year":return dateStr.substring(0,7);default:return dateStr;}return dateStr;}});var dummyInstance=new Alfea.component.ActivityStats("null");})();